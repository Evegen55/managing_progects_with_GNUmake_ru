%%%-------------------------------------------------------------------
%%% How to write a simple makefile
%%%-------------------------------------------------------------------
\chapter{Как написать простой \Makefile{}}
\label{chap:simple_makefile}
Механизм создания программ обычно довольно прост: редактирование
исходного кода, компиляция в исполняемый файл и отладка полученной
программы. Несмотря на то, что компиляция считается рутинной
операцией, будучи проведённой некорректно, она может породить ошибки,
на исправление которых у программиста уйдёт очень много времени.
Многие разработчики испытывают удивление, когда после исправления
какой-нибудь функции и запуска нового варианта программы видят,
что их изменения не исправляют ошибок. Позже они обнаружат, что их
модифицированный код никогда не выполнялся по причине ошибки процедуры
компиляции, компоновки или сборки JAR\hyp{}архива. Более того, с
ростом сложности программ эти рутинные задачи становятся источниками
всё более сложных ошибок, поскольку одновременно могут разрабатываться
различные версии приложения, например, для разных платформ или с
использованием разных версий библиотек.

Программа \GNUmake{} была разработана для того, чтобы автоматизировать
рутинные задачи трансформации исходного кода в исполняемые файлы.
Преимущество \GNUmake{} над простыми сценариями командного
интерпретатора состоит в возможности описать отношения между
элементами проекта. \GNUmake{}, основываясь на описанных отношениях и
данных о времени модификации файлов, сможет определить, какие именно
шаги необходимо осуществить для получения необходимой вам версии
программы. Используя эту информацию, \GNUmake{} также сможет
оптимизировать процесс сборки и избежать выполнения ненужных действий.

GNU \GNUmake{} предоставляет язык для описания отношений между
исходным кодом, промежуточными и исполняемыми файлами.
\GNUmake{} также включает функциональность для управления
конфигурациями, реализации библиотек спецификаций, пригодных для
повторного использования, и параметризации процесса сборки через
механизм макросов, определяемых пользователем. \GNUmake{} может
рассматриваться как каркас всего процесса разработки, выделяющий
компоненты приложения и описывающий способы связать их в единое целое.

Спецификация, используемая \GNUmake{}, обычно сохраняется в файле с
именем \Makefile{}. Ниже приведён пример \Makefile{}'а пригодного для
сборки традиционной программы <<Hello, World>>:

{\footnotesize
\begin{verbatim}
hello: hello.c
    gcc hello.c -o hello
\end{verbatim}
}

Для того, чтобы собрать программу, достаточно выполнить в командном
интерпретаторе следующую команду:

{\footnotesize
\begin{alltt}
\$ \textbf{make}
\end{alltt}
}

Это приведёт к запуску \GNUmake{}, который затем прочитает \Makefile{}
и соберёт первую цель, определённую в нём. В итоге вы увидите
следующее:

{\footnotesize
\begin{alltt}
\$ \textbf{make}
gcc hello.c -o hello
\end{alltt}
}

Цель может быть передана в качестве аргумента командной строки,
в этом случае \GNUmake{} будет пытаться собрать указанную вами цель.
В противном случае для сборки будет выбрана первая цель, определённая
\index{Цели!по умолчанию}
в \Makefile{}'е (называемая также \newword{целью по умолчанию}).

Обычно цель по умолчанию предназначена для сборки всего приложения, и
процесс сборки этой цели состоит из определённой последовательности
шагов.  Например, довольно часто исходный код приложения должен быть
составлен при помощи программ наподобие \utility{flex} или
\utility{bison}. Полученный исходный код нужно скомпилировать в
объектные файлы (файлы с расширением \filename{.o} или \filename{.obj}
для \Clang{}/\Cplusplus{} и \filename{.class} для Java).  Затем
объектные файлы (для случая \Clang{}/\Cplusplus{}) должны быть собраны
компоновщиком (обычно вызываемым компилятором \utility{gcc}) для
получения исполняемого файла.

Модификация любого из исходных файлов требует повторного вызова
\GNUmake{}, который инициирует повторение некоторых (обычно не всех)
из вышеописанных действий таким образом, чтобы получить исполняемый
файл с новой функциональностью. Файл спецификаций, \Makefile{},
описывает отношения между исходным кодом, промежуточными и
исполняемыми файлами, что позволяет \GNUmake{} выполнять минимум
необходимой работы для получения новой версии исполняемого файла.

Принципиальное значение \GNUmake{} заключается в его возможности
осуществлять сложные последовательности операций, необходимые для
сборки приложения, и производить оптимизацию выполнения этих операций
для максимального сокращения времени, занимаемого циклом
<<модификация\hyp{}компиляция\hyp{}отладка>>. Более того, этот
инструмент настолько гибок, что может быть использован везде, где
существуют зависимости между файлами, начиная с традиционных программ
на \Clang/\Cplusplus{} и заканчивая приложениями на \Java{},
документами \TeX{}, управлением базами данных и конвертацией
изображений.

\input{./src/latex/part1/basic-concepts/targets-and-prereq.tex}
\input{./src/latex/part1/basic-concepts/dependency-checking.tex}
\input{./src/latex/part1/basic-concepts/minimizing-rebuilds.tex}
\input{./src/latex/part1/basic-concepts/invoking-make.tex}
\input{./src/latex/part1/basic-concepts/basic-syntax.tex}
